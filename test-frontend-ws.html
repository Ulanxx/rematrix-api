<!DOCTYPE html>
<html>
<head>
    <title>Frontend WebSocket Test</title>
</head>
<body>
    <h1>前端 WebSocket 连接测试</h1>
    <div id="status">状态: 未连接</div>
    <div id="messages"></div>
    <button onclick="testConnection()">测试连接</button>
    <button onclick="disconnect()">断开连接</button>

    <script>
        let ws = null;
        
        function updateStatus(message) {
            document.getElementById('status').textContent = '状态: ' + message;
        }
        
        function addMessage(message) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            messages.appendChild(div);
        }
        
        function testConnection() {
            // 模拟前端应用的连接方式
            const wsUrl = 'ws://localhost:3000/ws?token=demo-token';
            addMessage('尝试连接: ' + wsUrl);
            updateStatus('连接中...');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    updateStatus('已连接');
                    addMessage('WebSocket 连接成功');
                    
                    // 发送加入房间消息
                    ws.send(JSON.stringify({
                        type: 'join_job',
                        jobId: 'test-frontend-job'
                    }));
                    addMessage('已发送加入房间消息');
                };
                
                ws.onmessage = function(event) {
                    addMessage('收到消息: ' + event.data);
                    try {
                        const data = JSON.parse(event.data);
                        addMessage('解析的消息: ' + JSON.stringify(data, null, 2));
                    } catch (e) {
                        addMessage('无法解析消息');
                    }
                };
                
                ws.onclose = function(event) {
                    updateStatus('已断开');
                    addMessage('连接关闭: ' + event.code + ' - ' + event.reason);
                };
                
                ws.onerror = function(error) {
                    updateStatus('错误');
                    addMessage('WebSocket 错误: ' + error);
                };
                
            } catch (error) {
                updateStatus('错误');
                addMessage('创建连接失败: ' + error.message);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
    </script>
</body>
</html>
